name: Devcontainer Build Test

on:
  workflow_dispatch:

jobs:
  test-devcontainer-build:
    name: Test Devcontainer Build (${{ matrix.image_name }}:${{ matrix.image_tag }}, ${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        # Note: Windows runners only support Windows containers, not Linux containers
        # so we cannot test Linux devcontainers on Windows runners
        include:
          - runner: ubuntu-latest
            image_name: public.ecr.aws/docker/library/ubuntu
            image_tag: "24.04"
          - runner: ubuntu-latest
            image_name: public.ecr.aws/docker/library/debian
            image_tag: bookworm
          - runner: ubuntu-24.04-arm
            image_name: public.ecr.aws/docker/library/ubuntu
            image_tag: "24.04"
          - runner: ubuntu-24.04-arm
            image_name: public.ecr.aws/docker/library/debian
            image_tag: bookworm
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install Node.js
        uses: actions/setup-node@v6

      - name: Install devcontainer CLI
        run: |
          npm install -g @devcontainers/cli

      - name: Devcontainer help
        run: |
          devcontainer up --help
          devcontainer set-up --help
          devcontainer build --help

      - name: Prepare host files
        run: |
          # Create required host files that will be mounted
          touch ~/.netrc
          touch ~/.gitconfig

          # Create a minimal .pre-commit-config.yaml to test hook installation
          cat > .pre-commit-config.yaml << 'EOF'
          repos:
            - repo: https://github.com/pre-commit/pre-commit-hooks
              rev: v4.5.0
              hooks:
                - id: trailing-whitespace
          EOF
          echo "Created .pre-commit-config.yaml for testing"

      - name: Create custom configurations for testing
        run: |
          echo "=== Creating custom configuration files for testing ==="
          echo "Base image: ${{ matrix.image_name }}:${{ matrix.image_tag }}"

          # Create packages.custom.yml with test customizations and base image override
          cat > .devcontainer/docker/packages.custom.yml << EOF
          # Test custom packages with base image override
          image_name: ${{ matrix.image_name }}
          image_tag: "${{ matrix.image_tag }}"

          base:
            packages:
              - jq
            python_tools: []

          devenv:
            packages: []
            python_tools:
              - ruff
          EOF
          echo "Created packages.custom.yml"

          # Create docker-compose.custom.yml with test environment variable
          cat > .devcontainer/docker/docker-compose.custom.yml << 'EOF'
          services:
            devcontainer:
              environment:
                - TEST_CUSTOM_VAR=custom_test_value
          EOF
          echo "Created docker-compose.custom.yml"

          echo "Custom configurations created"

      - name: Validate devcontainer configuration
        run: |
          echo "=== Validating devcontainer.json ==="
          devcontainer read-configuration --workspace-folder . > /dev/null
          echo "✓ Configuration is valid"

      - name: Build and start devcontainer
        run: |
          # devcontainer up will:
          # 1. Run initializeCommand (initialize.py) on the host
          # 2. Build the container image
          # 3. Start the container
          # 4. Run postStartCommand inside the container
          devcontainer up --workspace-folder .

      - name: Verify initialization completed
        run: |
          echo "=== Verifying initializeCommand executed ==="
          # Check that initialize.py created required files
          test -f .devcontainer/docker/.env || { echo 'ERROR: .env not generated'; exit 1; }
          test -f .devcontainer/docker/packages.yml || { echo 'ERROR: packages.yml not generated'; exit 1; }
          echo "✓ Initialization files generated by initializeCommand"

      - name: Verify custom packages merged
        run: |
          echo "=== Verifying custom packages were merged ==="

          # Check packages.yml contains jq from custom config
          grep -q "jq" .devcontainer/docker/packages.yml || {
            echo 'ERROR: jq not found in merged packages.yml'
            exit 1
          }
          echo "✓ jq found in merged packages.yml"

          # Check packages.yml contains ruff from custom config
          grep -q "ruff" .devcontainer/docker/packages.yml || {
            echo 'ERROR: ruff not found in merged packages.yml'
            exit 1
          }
          echo "✓ ruff found in merged packages.yml"

          echo "✓ Custom packages merge verification passed"

      - name: Verify base image
        run: |
          # Extract distro name from image path (e.g., ghcr.io/dockerlibrary/ubuntu -> ubuntu)
          DISTRO=$(basename '${{ matrix.image_name }}')
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Verifying base image ==='

            # Check OS release info
            cat /etc/os-release

            # Verify we're running the expected distro
            if grep -qi '${DISTRO}' /etc/os-release; then
              echo '✓ Running on ${DISTRO} as expected'
            else
              echo 'ERROR: Expected ${DISTRO} but got different distro'
              exit 1
            fi

            echo '✓ Base image verification passed'
          "

      - name: Test base tools
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Testing base tools ==='
            git --version
            curl --version
            yq --version
            uv --version
            bazelisk --version
            echo '✓ Base tools test passed'
          "

      - name: Test user and workspace configuration
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Testing user and workspace ==='

            # Test user identity
            echo \"Current user: \$(whoami)\"
            echo \"Current directory: \$(pwd)\"

            # Test workspace exists
            test -d /workspace || { echo 'ERROR: /workspace missing'; exit 1; }

            # Verify UID/GID match expected values
            echo \"UID: \$(id -u), GID: \$(id -g)\"

            echo '✓ User and workspace test passed'
          "

      - name: Test volume mounts and permissions
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Testing volume mounts and permissions ==='

            # Test named volumes are writable
            test -w ~/.local/share || { echo 'ERROR: local-share not writable'; exit 1; }
            echo '✓ local-share volume writable'

            test -w ~/.config || { echo 'ERROR: config not writable'; exit 1; }
            echo '✓ config volume writable'

            test -w ~/.cache || { echo 'ERROR: cache not writable'; exit 1; }
            echo '✓ cache volume writable'

            test -w ~/.vscode-server/extensions || { echo 'ERROR: vscode-ext not writable'; exit 1; }
            echo '✓ vscode-ext volume writable'

            # Test read-only host mounts are readable
            test -r ~/.netrc || { echo 'ERROR: .netrc not readable'; exit 1; }
            echo '✓ .netrc readable'

            test -r ~/.gitconfig || { echo 'ERROR: .gitconfig not readable'; exit 1; }
            echo '✓ .gitconfig readable'

            # Verify read-only mounts cannot be written to
            if touch ~/.gitconfig 2>/dev/null; then
              echo 'ERROR: .gitconfig should be read-only'
              exit 1
            fi
            echo '✓ .gitconfig is read-only'

            echo '✓ Volume mounts test passed'
          "

      - name: Test shell configuration
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Testing shell configuration ==='

            test -f ~/.vscode_profile || { echo 'ERROR: .vscode_profile missing'; exit 1; }
            echo '✓ .vscode_profile exists'

            test -f ~/.inputrc || { echo 'ERROR: .inputrc missing'; exit 1; }
            echo '✓ .inputrc exists'

            echo '✓ Shell configuration test passed'
          "

      - name: Test git configuration
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Testing git configuration ==='

            # Test .gitconfig is readable (mounted from host)
            test -r ~/.gitconfig || { echo 'ERROR: .gitconfig not readable'; exit 1; }
            echo '✓ .gitconfig mounted from host'

            # Test .gitconfig is read-only
            if touch ~/.gitconfig 2>/dev/null; then
              echo 'ERROR: .gitconfig should be read-only'
              exit 1
            fi
            echo '✓ .gitconfig is read-only (as expected)'

            # Test git works
            git status > /dev/null
            echo '✓ Git commands work'

            echo '✓ Git configuration test passed'
          "

      - name: Test lazy-loaded Python tools
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Testing lazy-loaded Python tools ==='

            # Test uvx-shim wrapper exists
            command -v pre-commit || { echo 'ERROR: pre-commit not available'; exit 1; }
            echo '✓ pre-commit available via uvx-shim'

            # Test lazy loading actually works by invoking the tool
            pre-commit --version || { echo 'ERROR: pre-commit failed to execute'; exit 1; }
            echo '✓ pre-commit executes successfully'

            echo '✓ Lazy-loaded tools test passed'
          "

      - name: Test pre-commit hook installation
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Testing pre-commit hook installation ==='

            # Verify .pre-commit-config.yaml exists
            test -f /workspace/.pre-commit-config.yaml || {
              echo 'ERROR: .pre-commit-config.yaml not found'
              exit 1
            }
            echo '✓ .pre-commit-config.yaml exists'

            # Verify git hooks directory exists
            test -d /workspace/.git/hooks || {
              echo 'ERROR: .git/hooks directory not found'
              exit 1
            }
            echo '✓ .git/hooks directory exists'

            # Verify pre-commit hook was installed
            test -f /workspace/.git/hooks/pre-commit || {
              echo 'ERROR: pre-commit hook not installed'
              exit 1
            }
            echo '✓ pre-commit hook file exists'

            # Verify it's actually a pre-commit managed hook
            grep -q 'pre-commit' /workspace/.git/hooks/pre-commit || {
              echo 'ERROR: pre-commit hook does not appear to be managed by pre-commit'
              exit 1
            }
            echo '✓ pre-commit hook is properly installed'

            echo '✓ Pre-commit hook installation test passed'
          "

      - name: Test custom configurations
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Testing custom configurations ==='

            # Test custom apt package (jq) was installed
            command -v jq || { echo 'ERROR: jq not installed'; exit 1; }
            jq --version
            echo '✓ Custom apt package (jq) installed'

            # Test custom Python tool (ruff) is available via uvx-shim
            command -v ruff || { echo 'ERROR: ruff not available'; exit 1; }
            echo '✓ Custom Python tool (ruff) available via uvx-shim'

            # Test ruff actually works (lazy loading)
            ruff --version || { echo 'ERROR: ruff failed to execute'; exit 1; }
            echo '✓ Custom Python tool (ruff) executes successfully'

            # Test custom environment variable
            test \"\$TEST_CUSTOM_VAR\" = \"custom_test_value\" || {
              echo \"ERROR: TEST_CUSTOM_VAR not set correctly (got: '\$TEST_CUSTOM_VAR')\"
              exit 1
            }
            echo \"✓ Custom environment variable set: TEST_CUSTOM_VAR=\$TEST_CUSTOM_VAR\"

            echo '✓ Custom configurations test passed'
          "

      - name: Test devenv layer packages
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Testing devenv layer packages ==='

            # Test bash-completion is installed
            test -f /usr/share/bash-completion/bash_completion || {
              echo 'ERROR: bash-completion not installed'
              exit 1
            }
            echo '✓ bash-completion installed'

            # Verify bash-completion can be sourced without errors
            bash -c 'source /usr/share/bash-completion/bash_completion' || {
              echo 'ERROR: bash-completion cannot be sourced'
              exit 1
            }
            echo '✓ bash-completion can be sourced'

            echo '✓ Devenv layer packages test passed'
          "

      - name: Test lifecycle commands
        run: |
          echo "=== Testing lifecycle commands ==="
          # Note: run-user-commands runs onCreateCommand, updateContentCommand, postCreateCommand
          # Since we already ran 'up', these should have already executed
          # This validates they can be run explicitly
          devcontainer run-user-commands --workspace-folder . || {
            echo "WARNING: run-user-commands failed (may be expected if commands already ran)"
          }
          echo "✓ Lifecycle commands test completed"

      - name: Test environment variables
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Testing environment variables ==='

            # Test WORKSPACE_ROOT is set
            test -n \"\$WORKSPACE_ROOT\" || { echo 'ERROR: WORKSPACE_ROOT not set'; exit 1; }
            echo \"WORKSPACE_ROOT: \$WORKSPACE_ROOT\"

            # Test USER is set correctly
            test \"\$USER\" = \"\$(whoami)\" || { echo 'ERROR: USER env var mismatch'; exit 1; }
            echo \"USER: \$USER\"

            echo '✓ Environment variables test passed'
          "

      - name: Test volume persistence - write data
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Writing test data to persistent volumes ==='

            # Write to bash history location (in local-share volume)
            mkdir -p ~/.local/share/bash
            echo 'PERSISTENCE_TEST_MARKER_12345' >> ~/.local/share/bash/history
            echo '✓ Written marker to local-share volume'

            # Write to config volume
            mkdir -p ~/.config/persistence-test
            echo 'config_persistence_test_data' > ~/.config/persistence-test/marker.txt
            echo '✓ Written marker to config volume'

            # Write to cache volume
            mkdir -p ~/.cache/persistence-test
            echo 'cache_persistence_test_data' > ~/.cache/persistence-test/marker.txt
            echo '✓ Written marker to cache volume'

            echo '✓ Test data written to all persistent volumes'
          "

      - name: Test volume persistence - restart container
        run: |
          echo "=== Restarting container to test persistence ==="

          # Stop the container
          docker compose -f .devcontainer/docker/docker-compose.default.yml \
                         -f .devcontainer/docker/docker-compose.custom.yml \
                         --env-file .devcontainer/docker/.env \
                         stop devcontainer
          echo "✓ Container stopped"

          # Start it again (not rebuild - just start)
          docker compose -f .devcontainer/docker/docker-compose.default.yml \
                         -f .devcontainer/docker/docker-compose.custom.yml \
                         --env-file .devcontainer/docker/.env \
                         start devcontainer
          echo "✓ Container started"

          # Wait for container to be ready
          sleep 5
          echo "✓ Container restart complete"

      - name: Test volume persistence - verify data
        run: |
          devcontainer exec --workspace-folder . bash -c "
            set -e
            echo '=== Verifying persistent data after restart ==='

            # Check local-share volume persistence
            grep -q 'PERSISTENCE_TEST_MARKER_12345' ~/.local/share/bash/history || {
              echo 'ERROR: local-share marker not found after restart'
              exit 1
            }
            echo '✓ Local-share data persisted'

            # Check config volume persistence
            test -f ~/.config/persistence-test/marker.txt || {
              echo 'ERROR: config marker file not found after restart'
              exit 1
            }
            grep -q 'config_persistence_test_data' ~/.config/persistence-test/marker.txt || {
              echo 'ERROR: config marker content not found'
              exit 1
            }
            echo '✓ Config data persisted'

            # Check cache volume persistence
            test -f ~/.cache/persistence-test/marker.txt || {
              echo 'ERROR: cache marker file not found after restart'
              exit 1
            }
            grep -q 'cache_persistence_test_data' ~/.cache/persistence-test/marker.txt || {
              echo 'ERROR: cache marker content not found'
              exit 1
            }
            echo '✓ Cache data persisted'

            echo '✓ Volume persistence test passed'
          "

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "========================================="
          echo "✓ All devcontainer tests passed!"
          echo "========================================="
          echo ""
          echo "Base image: ${{ matrix.image_name }}:${{ matrix.image_tag }}"
          echo ""
          echo "Tests completed:"
          echo "  ✓ Configuration validation"
          echo "  ✓ Custom configuration setup"
          echo "  ✓ Build and start (with automatic initializeCommand)"
          echo "  ✓ Initialization verification"
          echo "  ✓ Custom packages merge verification"
          echo "  ✓ Base image verification"
          echo "  ✓ Base tools"
          echo "  ✓ User and workspace"
          echo "  ✓ Volume mounts and permissions"
          echo "  ✓ Shell configuration"
          echo "  ✓ Git configuration"
          echo "  ✓ Lazy-loaded Python tools"
          echo "  ✓ Pre-commit hook installation"
          echo "  ✓ Custom configurations (apt packages, Python tools, env vars)"
          echo "  ✓ Devenv layer packages"
          echo "  ✓ Lifecycle commands"
          echo "  ✓ Environment variables"
          echo "  ✓ Volume persistence (write/restart/verify)"
          echo ""
